<!DOCTYPE html>
<html>
<head>
  <title>Optimized Mobile Composite Multi-Stream with Audio Selection</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { margin: 0; background: #000; overflow: hidden; }
    #compositeCanvas { display: block; width: 100vw; height: 100vh; }
    #audioControls {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .hidden-video { position: absolute; width: 1px; height: 1px; opacity: 0; }
  </style>
</head>
<body>
  <video id="vid1" class="hidden-video" autoplay playsinline muted></video>
  <video id="vid2" class="hidden-video" autoplay playsinline muted></video>
  <video id="vid3" class="hidden-video" autoplay playsinline muted></video>
  <video id="vid4" class="hidden-video" autoplay playsinline muted></video>
  
  <canvas id="compositeCanvas"></canvas>
  
  <div id="audioControls">
    <button onclick="selectAudio(0)">Audio 1</button>
    <button onclick="selectAudio(1)">Audio 2</button>
    <button onclick="selectAudio(2)">Audio 3</button>
    <button onclick="selectAudio(3)">Audio 4</button>
  </div>
  
  <script>
    const streams = [
      "https://watchlivestream.sbs/o4",
      "https://watchlivestream.sbs/o5",
      "https://watchlivestream.sbs/o2",
      "https://watchlivestream.sbs/o3"
    ];
    const videoElements = [
      document.getElementById("vid1"),
      document.getElementById("vid2"),
      document.getElementById("vid3"),
      document.getElementById("vid4")
    ];
    
    videoElements.forEach((video, i) => {
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(streams[i]);
        hls.attachMedia(video);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = streams[i];
      }
    });
    
    const canvas = document.getElementById("compositeCanvas");
    const ctx = canvas.getContext("2d");
    
    // Set canvas size using devicePixelRatio for better resolution on mobile.
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const width = window.innerWidth;
      const height = window.innerHeight;
      canvas.style.width = width + "px";
      canvas.style.height = height + "px";
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    
    let lastDrawTime = 0;
    function drawComposite(timestamp) {
      // Limit to ~30 fps (33ms per frame)
      if(timestamp - lastDrawTime < 33) {
         requestAnimationFrame(drawComposite);
         return;
      }
      lastDrawTime = timestamp;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const halfWidth = canvas.width / (2 * (window.devicePixelRatio || 1));
      const halfHeight = canvas.height / (2 * (window.devicePixelRatio || 1));
      
      // Only draw if each video is ready (readyState 2 or higher)
      if(videoElements[0].readyState >= 2)
        ctx.drawImage(videoElements[0], 0, 0, halfWidth, halfHeight);
      if(videoElements[1].readyState >= 2)
        ctx.drawImage(videoElements[1], halfWidth, 0, halfWidth, halfHeight);
      if(videoElements[2].readyState >= 2)
        ctx.drawImage(videoElements[2], 0, halfHeight, halfWidth, halfHeight);
      if(videoElements[3].readyState >= 2)
        ctx.drawImage(videoElements[3], halfWidth, halfHeight, halfWidth, halfHeight);
      
      requestAnimationFrame(drawComposite);
    }
    requestAnimationFrame(drawComposite);
    
    // Audio selection: unmute the chosen stream and mute the others.
    function selectAudio(index) {
      videoElements.forEach((video, i) => {
        video.muted = (i !== index);
      });
    }
    // Auto-select the first streamâ€™s audio.
    selectAudio(0);
  </script>
</body>
</html>